<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reproducing Montlake Eastside Seattle, US • abstr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Reproducing Montlake Eastside Seattle, US">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">abstr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.4.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/abstr.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/activity.html">Multi-trip activity models</a>
    </li>
    <li>
      <a href="../articles/montlake.html">Reproducing Montlake Eastside Seattle, US</a>
    </li>
    <li>
      <a href="../articles/pct_to_abstr.html">Visualising cycling potential with A/B Street</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/a-b-street/abstr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Reproducing Montlake Eastside Seattle, US</h1>
                        <h4 data-toc-skip class="author">Robin Lovelace,
Trevor Nederlof and Nathanael Sheehan</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/a-b-street/abstr/blob/main/vignettes/montlake.Rmd" class="external-link"><code>vignettes/montlake.Rmd</code></a></small>
      <div class="hidden name"><code>montlake.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Lets start with the city A/B street began, Seattle. U.S. The seaport
city is home to over 700,000 people, including A/B Street creator,
Dustin Carlino, who has been developing tools to empirically study the
impact of small changes within the road network: this means “you can
transform that street parking into a bus lane or fix that pesky left
turn at a traffic signal, measure the effects, then propose actually
making the change”. For the past two years, Seattle has been a key are
of study within the A/B street simuverse and thus makes it a great
starting point in understanding the utilities of <code>abstr</code> to
generate site data for A/B street.</p>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>This example demonstrates how to wrangle the data for the three key
components needsed to generate scenarios for A/B street. These
components are: OD data, site zones and site buildings. With these
components, the <code>abstr</code> package is ready to convert
dataframes into simulations! The kinds of data processing steps
demonstrated in this vignette could be applied to generate
‘scenario.json’ files for other cities, and represent a reproducibility
challenge: can you reproduce the results shown in the final .json file
at the end of the vignette?</p>
<p>Lets get started.</p>
<div class="section level3">
<h3 id="load-packages">Load packages<a class="anchor" aria-label="anchor" href="#load-packages"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/a-b-street/abstr" class="external-link">abstr</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fetch-montlake-polygon">Fetch Montlake Polygon<a class="anchor" aria-label="anchor" href="#fetch-montlake-polygon"></a>
</h3>
<p>Now lets start with fetching the polygon area for Montlake. To be
consistent with whats on A/B street currently, we can grab the official
polygon from the github repo. Following this we can clean the data and
convert it to WGS84.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">montlake_poly_url</span> <span class="op">=</span> <span class="st">"https://github.com/a-b-street/abstreet/raw/refs/heads/main/importer/config/us/seattle/montlake.geojson"</span></span>
<span><span class="va">boundary_sf_poly</span> <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">montlake_poly_url</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="parsing-zones">Parsing zones<a class="anchor" aria-label="anchor" href="#parsing-zones"></a>
</h3>
<p>Next, we fetch zone data for the Seattle district, this comes from
soundcast and needs to be parsed based on our polygon boundary.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">all_zones_tbl</span> <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/psrc/soundcast/master/inputs/base_year/taz2010.geojson"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span></span>
<span><span class="va">zones_in_boundary_tbl</span> <span class="op">=</span> <span class="va">all_zones_tbl</span><span class="op">[</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html" class="external-link">st_intersects</a></span><span class="op">(</span><span class="va">all_zones_tbl</span>, <span class="va">boundary_sf_poly</span>, sparse <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>,<span class="op">]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="generate-od-matrix-and-zones-table">Generate OD Matrix and zones table<a class="anchor" aria-label="anchor" href="#generate-od-matrix-and-zones-table"></a>
</h3>
<p>Now we need to get some OD data into the mix. Finding this data for
some cities can be tricky, luckily soundcast provides granular data for
trips in Seattle for 2014. This data is then converted to an OD matrix
and is filtered by trips that start or finish in Montlake zones.
Furthermore, the data is then transformed into a wide format and
filtered to only include OD entries with greater than 25 trips. Voila,
the OD data is ready to go. The OD data is then parsed against all zones
in the montlake area.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## process the disagreggated soundcast trips data</span></span>
<span><span class="va">all_trips_tbl</span> <span class="op">=</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"http://abstreet.s3-website.us-east-2.amazonaws.com/dev/data/input/us/seattle/trips_2014.csv.gz"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## create a OD matrix</span></span>
<span><span class="va">od_tbl_long</span> <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">all_trips_tbl</span>, <span class="va">otaz</span>, <span class="va">dtaz</span>, <span class="va">mode</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="va">mode</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">9</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Walk"</span>,</span>
<span>                                        <span class="va">mode</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Bike"</span>,</span>
<span>                                        <span class="va">mode</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">5</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Drive"</span>,</span>
<span>                                        <span class="va">mode</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">7</span>, <span class="fl">8</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Transit"</span>,</span>
<span>                                        <span class="cn">TRUE</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">mode</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">otaz</span>, <span class="va">dtaz</span>, <span class="va">mode</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># only keep an entry if the origin or destination is in a Montlake zone</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">(</span><span class="va">otaz</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">zones_in_boundary_tbl</span><span class="op">$</span><span class="va">TAZ</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span><span class="va">dtaz</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">zones_in_boundary_tbl</span><span class="op">$</span><span class="va">TAZ</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a wide OD matrix and filter out any OD entries with under 25 trips in it</span></span>
<span><span class="va">montlake_od_tbl</span> <span class="op">=</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span><span class="va">od_tbl_long</span>, names_from <span class="op">=</span> <span class="va">mode</span>, values_from <span class="op">=</span> <span class="va">n</span>, values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>o_id <span class="op">=</span> <span class="va">otaz</span>, d_id <span class="op">=</span> <span class="va">dtaz</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>total <span class="op">=</span> <span class="va">Drive</span> <span class="op">+</span> <span class="va">Transit</span> <span class="op">+</span> <span class="va">Bike</span> <span class="op">+</span> <span class="va">Walk</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">total</span> <span class="op">&gt;=</span> <span class="fl">25</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">total</span><span class="op">)</span></span>
<span></span>
<span><span class="va">montlake_zone_tbl</span> <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">right_join</a></span><span class="op">(</span><span class="va">all_zones_tbl</span>,</span>
<span>                                       <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="st">"TAZ"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">montlake_od_tbl</span><span class="op">$</span><span class="va">o_id</span>, <span class="va">montlake_od_tbl</span><span class="op">$</span><span class="va">d_id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                       by <span class="op">=</span> <span class="st">"TAZ"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">TAZ</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">TAZ</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fetching-osm-building-data">Fetching OSM building data<a class="anchor" aria-label="anchor" href="#fetching-osm-building-data"></a>
</h3>
<p>A/B street functions by generating buildings based on OSM entries,
luckily the <code>osmextract</code> makes this an easy process in R. OSM
buildings must be valid <code>sf</code> objects so that they can be
parsed against the zone areas. To speed things up, the later part of
this chunk selects 20% of buildings in each zone.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">osm_polygons</span> <span class="op">=</span> <span class="fu">osmextract</span><span class="fu">::</span><span class="fu">oe_read</span><span class="op">(</span><span class="st">"http://download.geofabrik.de/north-america/us/washington-latest.osm.pbf"</span>, layer <span class="op">=</span> <span class="st">"multipolygons"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">building_types</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"yes"</span>, <span class="st">"house"</span>, <span class="st">"detached"</span>, <span class="st">"residential"</span>, <span class="st">"apartments"</span>,</span>
<span>                    <span class="st">"commercial"</span>, <span class="st">"retail"</span>, <span class="st">"school"</span>, <span class="st">"industrial"</span>, <span class="st">"semidetached_house"</span>,</span>
<span>                    <span class="st">"church"</span>, <span class="st">"hangar"</span>, <span class="st">"mobile_home"</span>, <span class="st">"warehouse"</span>, <span class="st">"office"</span>,</span>
<span>                    <span class="st">"college"</span>, <span class="st">"university"</span>, <span class="st">"public"</span>, <span class="st">"garages"</span>, <span class="st">"cabin"</span>, <span class="st">"hospital"</span>,</span>
<span>                    <span class="st">"dormitory"</span>, <span class="st">"hotel"</span>, <span class="st">"service"</span>, <span class="st">"parking"</span>, <span class="st">"manufactured"</span>,</span>
<span>                    <span class="st">"civic"</span>, <span class="st">"farm"</span>, <span class="st">"manufacturing"</span>, <span class="st">"floating_home"</span>, <span class="st">"government"</span>,</span>
<span>                    <span class="st">"bungalow"</span>, <span class="st">"transportation"</span>, <span class="st">"motel"</span>, <span class="st">"manufacture"</span>, <span class="st">"kindergarten"</span>,</span>
<span>                    <span class="st">"house_boat"</span>, <span class="st">"sports_centre"</span><span class="op">)</span></span>
<span><span class="va">osm_buildings</span> <span class="op">=</span> <span class="va">osm_polygons</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">building</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">building_types</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">osm_way_id</span>, <span class="va">name</span>, <span class="va">building</span><span class="op">)</span></span>
<span></span>
<span><span class="va">osm_buildings_valid</span> <span class="op">=</span> <span class="va">osm_buildings</span><span class="op">[</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_is_valid</a></span><span class="op">(</span><span class="va">osm_buildings</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span><span class="va">montlake_osm_buildings_all</span> <span class="op">=</span> <span class="va">osm_buildings_valid</span><span class="op">[</span><span class="va">montlake_zone_tbl</span>,<span class="op">]</span></span>
<span></span>
<span><span class="co"># # use to visualize the building data</span></span>
<span><span class="co"># tmap::tm_shape(boundary_sf_poly) + tmap::tm_borders() +</span></span>
<span><span class="co">#   tmap::tm_shape(montlake_osm_buildings) + tmap::tm_polygons(col = "building")</span></span>
<span></span>
<span><span class="co"># Filter down large objects for package -----------------------------------</span></span>
<span><span class="va">montlake_osm_buildings_all_joined</span> <span class="op">=</span> <span class="va">montlake_osm_buildings_all</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_join</a></span><span class="op">(</span><span class="va">montlake_zone_tbl</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2021</span><span class="op">)</span></span>
<span><span class="co"># select 20% of buildings in each zone to reduce file size for this example</span></span>
<span><span class="co"># remove this filter or increase the sampling to include more buildings</span></span>
<span><span class="va">montlake_osm_buildings_sample</span> <span class="op">=</span> <span class="va">montlake_osm_buildings_all_joined</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">osm_way_id</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">sample_frac</a></span><span class="op">(</span><span class="fl">0.20</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">montlake_osm_buildings_tbl</span> <span class="op">=</span> <span class="va">montlake_osm_buildings_all</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">osm_way_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">montlake_osm_buildings_sample</span><span class="op">$</span><span class="va">osm_way_id</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="generate-ab-street-scenarios-using-abstr">Generate A/B Street scenarios using <code>abstr</code><a class="anchor" aria-label="anchor" href="#generate-ab-street-scenarios-using-abstr"></a>
</h3>
<p>So now we are ready to generate simulation files. To do this, lets
combine each of the elements outlined above, the zone
(<code>montlake_zone_tbl</code>), building
(<code>montlake_osm_buildings_tbl</code>) and OD
(<code>montlake_od_tbl</code>) data. We do this using the ab_scenario()
function in the abstr package, which generates a data frame representing
travel between the montlake_buildings. While the OD data contains
information on origin and destination zone, ab_scenario()
‘disaggregates’ the data and randomly selects building within each
origin and destination zone to simulate travel at the individual level,
as illustrated in the chunk below which uses only a sample of the
montlake_od data, showing travel between three pairs of zones, to
illustrate the process:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># use subset of OD data for speed</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">montlake_od_minimal</span> <span class="op">=</span> <span class="va">montlake_od_tbl</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">montlake_od_tbl</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">output_sf</span> <span class="op">=</span> <span class="fu"><a href="../reference/ab_scenario.html">ab_scenario</a></span><span class="op">(</span></span>
<span>  od <span class="op">=</span> <span class="va">montlake_od_minimal</span>,</span>
<span>  zones <span class="op">=</span> <span class="va">montlake_zone_tbl</span>,</span>
<span>  zones_d <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  origin_buildings <span class="op">=</span> <span class="va">montlake_osm_buildings_tbl</span>,</span>
<span>  destination_buildings <span class="op">=</span> <span class="va">montlake_osm_buildings_tbl</span>,</span>
<span>  <span class="co"># destinations2 = NULL,</span></span>
<span>  pop_var <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  time_fun <span class="op">=</span> <span class="va">ab_time_normal</span>,</span>
<span>  output <span class="op">=</span> <span class="st">"sf"</span>,</span>
<span>  modes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Walk"</span>, <span class="st">"Bike"</span>, <span class="st">"Drive"</span>, <span class="st">"Transit"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># # visualize the results</span></span>
<span><span class="co"># tmap::tm_shape(res) + tmap::tm_lines(col="mode") +</span></span>
<span><span class="co">#   tmap::tm_shape(montlake_zone_tbl) + tmap::tm_borders()</span></span>
<span></span>
<span><span class="co"># build json output</span></span>
<span><span class="fu"><a href="../reference/ab_save.html">ab_save</a></span><span class="op">(</span><span class="fu"><a href="../reference/ab_json.html">ab_json</a></span><span class="op">(</span><span class="va">output_sf</span>, time_fun <span class="op">=</span> <span class="va">ab_time_normal</span>,</span>
<span>                scenario_name <span class="op">=</span> <span class="st">"Montlake Example"</span><span class="op">)</span>,</span>
<span>        f <span class="op">=</span> <span class="st">"montlake.json"</span><span class="op">)</span></span></code></pre></div>
<p>Let’s see what is in the file:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/file.edit.html" class="external-link">file.edit</a></span><span class="op">(</span><span class="st">"montlake.json"</span><span class="op">)</span></span></code></pre></div>
<p>The first trip schedule should look something like this, matching <a href="https://a-b-street.github.io/docs/tech/dev/formats/" class="external-link">A/B Street’s
schema</a>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  <span class="dt">"scenario_name"</span><span class="fu">:</span> <span class="st">"Montlake Example"</span><span class="fu">,</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>  <span class="dt">"people"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>      <span class="dt">"trips"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>          <span class="dt">"departure"</span><span class="fu">:</span> <span class="dv">317760000</span><span class="fu">,</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>          <span class="dt">"origin"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>            <span class="dt">"Position"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>              <span class="dt">"longitude"</span><span class="fu">:</span> <span class="fl">-122.3139</span><span class="fu">,</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>              <span class="dt">"latitude"</span><span class="fu">:</span> <span class="fl">47.667</span></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>            <span class="fu">}</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>          <span class="fu">},</span></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>          <span class="dt">"destination"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>            <span class="dt">"Position"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>              <span class="dt">"longitude"</span><span class="fu">:</span> <span class="fl">-122.3187</span><span class="fu">,</span></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>              <span class="dt">"latitude"</span><span class="fu">:</span> <span class="fl">47.6484</span></span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>            <span class="fu">}</span></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>          <span class="fu">},</span></span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>          <span class="dt">"mode"</span><span class="fu">:</span> <span class="st">"Walk"</span><span class="fu">,</span></span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a>          <span class="dt">"purpose"</span><span class="fu">:</span> <span class="st">"Shopping"</span></span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a>      <span class="ot">]</span></span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a>    <span class="fu">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="importing-scenario-files-into-ab-street">Importing scenario files into A/B Street<a class="anchor" aria-label="anchor" href="#importing-scenario-files-into-ab-street"></a>
</h3>
<p>After generating a <code>montlake_scenario.json</code>, you can
import and simulate it as follows.</p>
<ol style="list-style-type: decimal">
<li>Run A/B Street, and choose “Sandbox” on the title screen.</li>
<li>If necessary, change the map to the Montlake district of Seattle, or
whichever map your JSON scenario covers.</li>
<li>Change the scenario from the default “weekday” pattern. Choose
“import JSON scenario,” then select your
<code>montlake_scenario.json</code> file.</li>
</ol>
<p>After you successfully import this file once, it will be available in
the list of scenarios, under the “Montlake Example” name, or whatever
<code>name</code> specified by the JSON file.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Robin Lovelace, Nathanael Sheehan, Trevor Nederlof, Dustin Carlino.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
